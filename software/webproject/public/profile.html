<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Προφίλ Χρήστη - Άσκηση 3">
    <meta name="author" content="George Kiosklis">
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css/assignment3.css">
    <title>Προφίλ Χρήστη - Άσκηση 3</title>
</head>
<body>
    <header class="bg-primary text-white text-center py-4">
        <h1>Προφίλ Χρήστη</h1>
        <p>Single Page Application με Session Management</p>
    </header>

    <div class="container mt-4">
        <div class="page-header">
            <h2>Εργασία 2: Διαχείριση Προφίλ</h2>
            <p>Login, προβολή και επεξεργασία προφίλ χωρίς ανανέωση σελίδας</p>
        </div>

        <!-- Login Section -->
        <div id="loginSection" class="profile-section active">
            <div class="content-box">
                <h3>Σύνδεση Χρήστη</h3>
                <form id="loginForm">
                    <div class="form-group">
                        <label for="loginUsername">Username:</label>
                        <input type="text" class="form-control" id="loginUsername" required>
                    </div>
                    <div class="form-group">
                        <label for="loginPassword">Password:</label>
                        <input type="password" class="form-control" id="loginPassword" required>
                    </div>
                    <button type="submit" class="btn btn-primary">Σύνδεση</button>
                </form>
                <div id="loginMessage" class="mt-3"></div>
            </div>
        </div>

        <!-- Profile View Section -->
        <div id="profileSection" class="profile-section">
            <div class="content-box">
                <h3>Το Προφίλ μου</h3>
                <div id="profileData"></div>
                <button id="editBtn" class="btn btn-primary mt-3">Επεξεργασία Προφίλ</button>
                <button id="logoutBtn" class="btn btn-secondary mt-3">Αποσύνδεση</button>
            </div>
        </div>

        <!-- Profile Edit Section -->
        <div id="editSection" class="profile-section">
            <div class="content-box">
                <h3>Επεξεργασία Προφίλ</h3>
                <form id="editForm">
                    <div class="form-group">
                        <label>Username:</label>
                        <input type="text" class="form-control" id="editUsername" readonly>
                        <small class="form-text text-muted">Το username δεν μπορεί να αλλάξει</small>
                    </div>
                    <div class="form-group">
                        <label>Email:</label>
                        <input type="email" class="form-control" id="editEmail" readonly>
                        <small class="form-text text-muted">Το email δεν μπορεί να αλλάξει</small>
                    </div>
                    <div class="form-group">
                        <label>Όνομα:</label>
                        <input type="text" class="form-control" id="editFirstname" required>
                    </div>
                    <div class="form-group">
                        <label>Επώνυμο:</label>
                        <input type="text" class="form-control" id="editLastname" required>
                    </div>
                    <div class="form-group">
                        <label>Χώρα:</label>
                        <input type="text" class="form-control" id="editCountry" required>
                    </div>
                    <div class="form-group">
                        <label>Πόλη:</label>
                        <input type="text" class="form-control" id="editCity">
                    </div>
                    <div class="form-group">
                        <label>Διεύθυνση:</label>
                        <input type="text" class="form-control" id="editAddress" required>
                    </div>
                    <div class="form-group">
                        <label>Τηλέφωνο:</label>
                        <input type="tel" class="form-control" id="editTelephone" required>
                    </div>
                    <button type="submit" class="btn btn-success">Αποθήκευση</button>
                    <button type="button" id="cancelBtn" class="btn btn-secondary">Ακύρωση</button>
                </form>
                <div id="editMessage" class="mt-3"></div>
            </div>
        </div>

        <!-- Instructions -->
        <div class="content-box">
            <h4>Οδηγίες Χρήσης</h4>
            <p><strong>Για να δοκιμάσετε την εφαρμογή:</strong></p>
            <ol>
                <li>Κάντε login με υπάρχοντα username/password από τη βάση</li>
                <li>Δείτε το προφίλ σας</li>
                <li>Πατήστε "Επεξεργασία Προφίλ"</li>
                <li>Αλλάξτε τα στοιχεία (εκτός από username/email)</li>
                <li>Αποθηκεύστε τις αλλαγές</li>
                <li>Αποσυνδεθείτε</li>
            </ol>
            <p><strong>Σημείωση:</strong> Το username και το email δεν μπορούν να αλλάξουν (read-only fields)</p>
        </div>
    </div>

    <footer class="text-white text-center py-3">
        <p>© 2025 - HY359 - Εργασία 3 - George Kiosklis</p>
    </footer>

    <script>
        "use strict";

        // Check session on page load
        window.addEventListener('DOMContentLoaded', checkSession);

        async function checkSession() {
            try {
                const response = await fetch('/api/profile', {
                    credentials: 'include'
                });
                if (response.ok) {
                    const user = await response.json();
                    showProfile(user);
                }
            } catch (error) {
                console.log('No active session');
            }
        }

        // Login
        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            
            try {
                const response = await fetch('/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ username, password })
                });
                
                const data = await response.json();
                const msgDiv = document.getElementById('loginMessage');
                
                if (response.ok) {
                    msgDiv.innerHTML = '<div class="status-success">Επιτυχής σύνδεση!</div>';
                    setTimeout(() => showProfile(data.user), 500);
                } else {
                    msgDiv.innerHTML = '<div class="status-error">' + data.error + '</div>';
                }
            } catch (error) {
                document.getElementById('loginMessage').innerHTML = 
                    '<div class="status-error">Σφάλμα σύνδεσης!</div>';
            }
        });

        // Show profile
        function showProfile(user) {
            document.getElementById('loginSection').classList.remove('active');
            document.getElementById('profileSection').classList.add('active');
            
            document.getElementById('profileData').innerHTML = `
                <div class="profile-info"><label>Username:</label> <span>${user.username}</span></div>
                <div class="profile-info"><label>Email:</label> <span>${user.email}</span></div>
                <div class="profile-info"><label>Όνομα:</label> <span>${user.firstname}</span></div>
                <div class="profile-info"><label>Επώνυμο:</label> <span>${user.lastname}</span></div>
                <div class="profile-info"><label>Ημ. Γέννησης:</label> <span>${user.birthdate}</span></div>
                <div class="profile-info"><label>Φύλο:</label> <span>${user.gender}</span></div>
                <div class="profile-info"><label>Χώρα:</label> <span>${user.country}</span></div>
                <div class="profile-info"><label>Πόλη:</label> <span>${user.city || '-'}</span></div>
                <div class="profile-info"><label>Διεύθυνση:</label> <span>${user.address}</span></div>
                <div class="profile-info"><label>Τηλέφωνο:</label> <span>${user.telephone}</span></div>
            `;
        }

        // Edit button
        document.getElementById('editBtn').addEventListener('click', async function() {
            const response = await fetch('/api/profile', { credentials: 'include' });
            const user = await response.json();
            
            document.getElementById('editUsername').value = user.username;
            document.getElementById('editEmail').value = user.email;
            document.getElementById('editFirstname').value = user.firstname;
            document.getElementById('editLastname').value = user.lastname;
            document.getElementById('editCountry').value = user.country;
            document.getElementById('editCity').value = user.city || '';
            document.getElementById('editAddress').value = user.address;
            document.getElementById('editTelephone').value = user.telephone;
            
            document.getElementById('profileSection').classList.remove('active');
            document.getElementById('editSection').classList.add('active');
        });

        // Cancel edit
        document.getElementById('cancelBtn').addEventListener('click', async function() {
            document.getElementById('editSection').classList.remove('active');
            document.getElementById('profileSection').classList.add('active');
        });

        // Save edit
        document.getElementById('editForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const data = {
                firstname: document.getElementById('editFirstname').value,
                lastname: document.getElementById('editLastname').value,
                country: document.getElementById('editCountry').value,
                city: document.getElementById('editCity').value,
                address: document.getElementById('editAddress').value,
                telephone: document.getElementById('editTelephone').value
            };
            
            try {
                const response = await fetch('/api/profile', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                const msgDiv = document.getElementById('editMessage');
                
                if (response.ok) {
                    msgDiv.innerHTML = '<div class="status-success">Επιτυχής ενημέρωση!</div>';
                    setTimeout(() => showProfile(result.user), 1000);
                } else {
                    msgDiv.innerHTML = '<div class="status-error">' + result.error + '</div>';
                }
            } catch (error) {
                document.getElementById('editMessage').innerHTML = 
                    '<div class="status-error">Σφάλμα ενημέρωσης!</div>';
            }
        });

        // Logout
        document.getElementById('logoutBtn').addEventListener('click', async function() {
            try {
                await fetch('/api/logout', {
                    method: 'POST',
                    credentials: 'include'
                });
                
                document.getElementById('profileSection').classList.remove('active');
                document.getElementById('loginSection').classList.add('active');
                document.getElementById('loginForm').reset();
                document.getElementById('editSection').classList.remove('active');
                document.getElementById('loginMessage').innerHTML = 
                    '<div class="status-success">Αποσυνδεθήκατε επιτυχώς!</div>';
            } catch (error) {
                alert('Σφάλμα αποσύνδεσης!');
            }
        });
    </script>

    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.2/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
</body>
</html>